name: CI with Unit Tests
on:
    push:
        branches:
            - main
            - development
    pull_request:
        branches: [main]
jobs:
    unit-tests:
        runs-on: ubuntu-22.04
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Install system dependencies including CAN modules
              run: |
                  sudo apt-get update
                  sudo apt-get install -y cmake build-essential pkg-config libevdev-dev libgtest-dev can-utils linux-modules-extra-$(uname -r)

            - name: Build Google Test
              run: |
                  cd /usr/src/gtest
                  sudo cmake CMakeLists.txt
                  sudo make
                  sudo cp lib/*.a /usr/lib

            - name: Create build directory
              run: mkdir -p Car_control/build

            - name: Configure with CMake
              run: |
                  cd Car_control/build
                  cmake -DBUILD_TESTS=ON ..

            - name: Build project
              run: |
                  cd Car_control/build
                  make

            - name: Run unit tests with ctest
              run: |
                  cd Car_control/build
                  ctest --output-on-failure --verbose
